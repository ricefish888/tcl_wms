打印("进入R101_补货生成规则")
打印("打印组织"+组织)
待补货列表 = 创建列表()
库位定位分类特性集 = 多值查表(组织,"R101_基础数据_库位定位分类特性表")
打印("试下库位定位分类特性集是否能取到值")
如果(库位定位分类特性集 == 空){
	 异常("R101_基础数据_库位定位分类特性表" + "未找到数据!")
}
每个($库位定位分类 : 库位定位分类特性集){

    打印("打印是否需要补货 :---"+$库位定位分类.是否支持补货)
    
    如果($库位定位分类.是否支持补货 == "true" || $库位定位分类.是否支持补货 == "是") {	

	  打印("补货区:---"+$库位定位分类.上架库位定位分类)
	  $库内安全库存集 = 数据查询(模型,组织,"R101_补货_安全库存集数据源", "仓库ID", 仓库ID,"补货区",  $库位定位分类.上架库位定位分类)
	  如果($库内安全库存集 == 空){
		异常("库内安全库存未找到补货区: "+ $库位定位分类.上架库位定位分类+" 的补货计划")
	  }

	  如果($库内安全库存集 != 空){
	  如果(列表大小($库内安全库存集) != 0){
	  每个($安全库存 : $库内安全库存集.安全库存集){
	  
	  $补货区当前库存数据集 = 数据查询(模型,组织,"R101_补货区当前库存数据源", "仓库ID", 仓库ID,"拣货库位定位分类", $库位定位分类.上架库位定位分类,"货品ID",$安全库存.货品ID)

	  $当前库存数据集是否为空 = 0 //0是 1是否


	  如果($补货区当前库存数据集 != 空 ){
	     $当前库存数据集是否为空 = 1
	  }
	  打印("计算库位定位分类库存---"+$库位定位分类.上架库位定位分类)
			如果($当前库存数据集是否为空 == 0) {
				$待补货明细 = 创建对象()
				$待补货明细.货品代码 = $安全库存.货品代码
				$待补货明细.货品ID = $安全库存.货品ID
				$待补货明细.补货区 = $库位定位分类.上架库位定位分类
				$待补货明细.货主代码 = $安全库存.货主代码
				$待补货明细.货主名称 = $安全库存.货主名称
				$待补货明细.计划补货数量 = $安全库存.最大数量
				打印("补货区当前库存数据集为空时待补货数量： "+$安全库存.最大数量)
				加入列表(待补货列表, $待补货明细)
			}

			如果($当前库存数据集是否为空 == 1){
				打印("当前库存数据集不为空时候: " + $补货区当前库存数据集)
				
				$总库存 = 0
				每个($当前库存数 : $补货区当前库存数据集.库存数据集){
				     $总库存 = $总库存 + $当前库存数.可用数量
				}

				打印("当前待补货区货品总数量: " + $总库存)
				如果($总库存 < $安全库存.最小数量){
					$待补货明细 = 创建对象()
					$待补货明细.货品代码 = $安全库存.货品代码
					$待补货明细.货品ID = $安全库存.货品ID
					$待补货明细.补货区 = $库位定位分类.上架库位定位分类
					$待补货明细.货主代码 = $安全库存.货主代码
					$待补货明细.货主名称 = $安全库存.货主名称
					$待补货明细.计划补货数量 = $安全库存.最大数量 - $总库存
					加入列表(待补货列表, $待补货明细)
				}
			}
		}
	     }
	  }
    
    }
}
如果(列表大小(待补货列表) == 0){
 异常("未获取到可待补货计划!")
}